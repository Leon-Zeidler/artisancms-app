From 2388b8bce2d6e91778bfa35e65c97041c48e3ef9 Mon Sep 17 00:00:00 2001
From: Codex <codex@openai.com>
Date: Wed, 5 Nov 2025 10:23:41 +0000
Subject: [PATCH] Fix runtime env guards for email flows
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

## Summary
- add runtime environment validation before creating Supabase and Resend clients in contact, testimonial request, and review token routes
- add Resend send-result handling plus resilient site URL resolution for testimonial email generation
- handle missing site URL configuration in the login password reset flow to prevent broken links

## Testing
- ⚠️ `npm run lint` *(aborted because Next.js launched an interactive configuration prompt)*
---
 src/app/api/contact/route.ts             | 184 +++++++++--------------
 src/app/api/request-testimonial/route.ts |  91 +++++++----
 src/app/api/review/verify-token/route.ts |  32 ++--
 src/app/login/page.tsx                   |  27 +++-
 4 files changed, 172 insertions(+), 162 deletions(-)

diff --git a/src/app/api/contact/route.ts b/src/app/api/contact/route.ts
index 104e53d..78844bf 100644
--- a/src/app/api/contact/route.ts
+++ b/src/app/api/contact/route.ts
@@ -2,166 +2,132 @@ import { NextResponse } from 'next/server';
 import { createClient } from '@supabase/supabase-js';
 import { Resend } from 'resend';
 
-// Log attempt to read the key (for build/initialization comparison)
-const initialResendApiKeyCheck = process.env.RESEND_API_KEY;
-console.log(`[API Contact - Top Level] Initial RESEND_API_KEY check. Found: ${initialResendApiKeyCheck ? 'Yes' : 'No'}`);
-
-// Use non-prefixed variable name
-const resendApiKey = process.env.RESEND_API_KEY;
-if (!resendApiKey) {
-    console.warn("[API Contact - Top Level] WARNING: RESEND_API_KEY missing during initial load.");
-}
-// *** Log Service Key Check ***
-const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
-console.log(`[API Contact - Top Level] Initial SUPABASE_SERVICE_ROLE_KEY check. Found: ${serviceRoleKey ? 'Yes (length: ' + serviceRoleKey.length + ')' : 'No'}`);
-
+export async function POST(request: Request) {
+  console.log('Contact API route POST handler started');
 
-const fromEmail = process.env.FROM_EMAIL || 'onboarding@resend.dev';
+  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
+  const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
+  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
+  const resendApiKey = process.env.RESEND_API_KEY;
+  const fromEmail = process.env.FROM_EMAIL || 'onboarding@resend.dev';
 
-// --- Supabase Admin Client ---
-// Ensure this key is available
-if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
-    console.error("[API Contact - Top Level] FATAL: SUPABASE_SERVICE_ROLE_KEY environment variable is missing!");
-    // Throwing here might break builds depending on usage, but indicates a critical config error
-    // throw new Error("Server configuration error: Missing SUPABASE_SERVICE_ROLE_KEY.");
-}
-const supabaseAdmin = createClient(
-  process.env.NEXT_PUBLIC_SUPABASE_URL!,
-  process.env.SUPABASE_SERVICE_ROLE_KEY!, // Use the variable
-  { auth: { autoRefreshToken: false, persistSession: false } }
-);
-
-// Regular client (not used for insert in this route)
-const supabase = createClient(
-    process.env.NEXT_PUBLIC_SUPABASE_URL!,
-    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
-);
+  if (!supabaseUrl || !serviceRoleKey) {
+    console.error('[API Contact - POST] FATAL: Supabase service configuration missing.');
+    return NextResponse.json({ error: 'Server configuration error: Database service key missing.' }, { status: 500 });
+  }
 
-export async function POST(request: Request) {
-  console.log("Contact API route POST handler started");
+  if (!anonKey) {
+    console.error('[API Contact - POST] FATAL: Supabase anon configuration missing.');
+    return NextResponse.json({ error: 'Server configuration error: Database anon key missing.' }, { status: 500 });
+  }
 
-  // Runtime check for keys
-  const resendApiKeyRuntime = process.env.RESEND_API_KEY;
-  const serviceKeyRuntime = process.env.SUPABASE_SERVICE_ROLE_KEY;
-  console.log(`[API Contact - POST] Runtime check RESEND_API_KEY: ${resendApiKeyRuntime ? 'Exists' : 'MISSING'}`);
-  console.log(`[API Contact - POST] Runtime check SUPABASE_SERVICE_ROLE_KEY: ${serviceKeyRuntime ? 'Exists' : 'MISSING'}`);
+  if (!resendApiKey) {
+    console.error('[API Contact - POST] FATAL: RESEND_API_KEY missing at runtime.');
+    return NextResponse.json({ error: 'Server configuration error: Email service key missing.' }, { status: 500 });
+  }
 
+  const supabaseAdmin = createClient(
+    supabaseUrl,
+    serviceRoleKey,
+    { auth: { autoRefreshToken: false, persistSession: false } },
+  );
 
-  if (!resendApiKeyRuntime) {
-      console.error("[API Contact - POST] FATAL: RESEND_API_KEY missing at runtime.");
-      return NextResponse.json({ error: "Server configuration error: Email service key missing." }, { status: 500 });
-  }
-   if (!serviceKeyRuntime) {
-       console.error("[API Contact - POST] FATAL: SUPABASE_SERVICE_ROLE_KEY missing at runtime.");
-       return NextResponse.json({ error: "Server configuration error: Database service key missing." }, { status: 500 });
-   }
+  const supabase = createClient(
+    supabaseUrl,
+    anonKey,
+  );
 
-  // Initialize Resend
-  const resend = new Resend(resendApiKeyRuntime);
+  const resend = new Resend(resendApiKey);
 
   let requestData;
-  try { requestData = await request.json(); }
-  catch (error) { return NextResponse.json({ error: "Invalid request body" }, { status: 400 }); }
+  try {
+    requestData = await request.json();
+  } catch (error) {
+    return NextResponse.json({ error: 'Invalid request body' }, { status: 400 });
+  }
 
   const { name, email: senderEmail, message, profileId } = requestData;
 
   // --- Validation ---
-  if (!name || !senderEmail || !message || !profileId) { return NextResponse.json({ error: "Name, email, message, and profileId are required" }, { status: 400 }); }
-  if (typeof name !== 'string' || typeof senderEmail !== 'string' || typeof message !== 'string' || typeof profileId !== 'string') { return NextResponse.json({ error: "Invalid data types provided" }, { status: 400 }); }
+  if (!name || !senderEmail || !message || !profileId) {
+    return NextResponse.json({ error: 'Name, email, message, and profileId are required' }, { status: 400 });
+  }
+  if (typeof name !== 'string' || typeof senderEmail !== 'string' || typeof message !== 'string' || typeof profileId !== 'string') {
+    return NextResponse.json({ error: 'Invalid data types provided' }, { status: 400 });
+  }
 
-  // --- Main Logic ---
   try {
-    // 1. Fetch Recipient Email AND Business Name
     console.log(`Fetching user email and profile for profileId: ${profileId}`);
 
-    // ---
-    // --- THIS IS THE FIX (Part 1) ---
-    // ---
-    // We fetch auth data AND profile data in parallel
     const [authResponse, profileResponse] = await Promise.all([
-        supabaseAdmin.auth.admin.getUserById(profileId),
-        supabaseAdmin.from('profiles').select('business_name').eq('id', profileId).single()
+      supabaseAdmin.auth.admin.getUserById(profileId),
+      supabaseAdmin.from('profiles').select('business_name').eq('id', profileId).single(),
     ]);
 
     const { data: userData, error: userError } = authResponse;
     const { data: profileData, error: profileError } = profileResponse;
 
     if (userError) {
-      console.error("Error fetching recipient user data:", userError); 
-      return NextResponse.json({ error: "Could not identify recipient auth." }, { status: 500 }); 
+      console.error('Error fetching recipient user data:', userError);
+      return NextResponse.json({ error: 'Could not identify recipient auth.' }, { status: 500 });
     }
     if (profileError) {
-      console.error("Error fetching recipient profile data:", profileError); 
-      return NextResponse.json({ error: "Could not identify recipient profile." }, { status: 500 }); 
+      console.error('Error fetching recipient profile data:', profileError);
+      return NextResponse.json({ error: 'Could not identify recipient profile.' }, { status: 500 });
     }
     if (!userData?.user?.email) {
-      console.error("Recipient email not found for ID:", profileId);
-      return NextResponse.json({ error: "Could not find recipient email." }, { status: 500 });
+      console.error('Recipient email not found for ID:', profileId);
+      return NextResponse.json({ error: 'Could not find recipient email.' }, { status: 500 });
     }
 
     const recipientEmail = userData.user.email;
     const recipientBusinessName = profileData?.business_name || 'Ihrer Webseite';
-    // ---
-    // --- END OF FIX (Part 1) ---
-    // ---
-    console.log(`Recipient email found: ${recipientEmail}, Business: ${recipientBusinessName}`);
-
 
-    // *** 2. Save Submission to DB (with detailed error logging) ***
     const submissionData = {
-        profile_id: profileId,
-        sender_name: name, // Use `name` from request body
-        sender_email: senderEmail, // Use `senderEmail` from request body
-        message: message,
-        is_read: false
+      profile_id: profileId,
+      sender_name: name, // Use `name` from request body
+      sender_email: senderEmail, // Use `senderEmail` from request body
+      message: message,
+      is_read: false,
     };
-    console.log("Attempting DB insert with data:", JSON.stringify(submissionData, null, 2)); // Log data before insert
+    console.log('Attempting DB insert with data:', JSON.stringify(submissionData, null, 2));
+
     const { error: insertError } = await supabaseAdmin
-        .from('contact_submissions')
-        .insert(submissionData);
+      .from('contact_submissions')
+      .insert(submissionData);
 
     if (insertError) {
-        // *** LOG THE DETAILED ERROR OBJECT ***
-        console.error("--- DATABASE INSERT FAILED ---");
-        console.error("Supabase Insert Error Code:", insertError.code);
-        console.error("Supabase Insert Error Message:", insertError.message);
-        console.error("Supabase Insert Error Details:", insertError.details);
-        console.error("Supabase Insert Error Hint:", insertError.hint);
-        // ***************************************
-        // Return an error to the frontend
-        return NextResponse.json({ error: "Failed to save submission to database." }, { status: 500 });
+      console.error('--- DATABASE INSERT FAILED ---');
+      console.error('Supabase Insert Error Code:', insertError.code);
+      console.error('Supabase Insert Error Message:', insertError.message);
+      console.error('Supabase Insert Error Details:', insertError.details);
+      console.error('Supabase Insert Error Hint:', insertError.hint);
+      return NextResponse.json({ error: 'Failed to save submission to database.' }, { status: 500 });
     }
-    console.log("Submission saved to DB successfully.");
-
+    console.log('Submission saved to DB successfully.');
 
-    // 3. Send Email (Only if DB insert succeeded)
     console.log(`Sending email via Resend from ${fromEmail} to ${recipientEmail}`);
     const emailHtml = ` <p>Sie haben eine neue Kontaktanfrage erhalten:</p> <ul> <li><strong>Name:</strong> ${name}</li> <li><strong>Email:</strong> ${senderEmail}</li> </ul> <p><strong>Nachricht:</strong></p> <p>${message.replace(/\n/g, '<br>')}</p> `;
-    
-    // ---
-    // --- THIS IS THE FIX (Part 2) ---
-    // ---
+
     const { data: emailData, error: emailError } = await resend.emails.send({
       from: `Kontaktformular <${fromEmail}>`,
       to: [recipientEmail],
       replyTo: senderEmail,
-      subject: `Neue Kontaktanfrage von ${name} über ${recipientBusinessName}`, // <-- Business name is now correct
+      subject: `Neue Kontaktanfrage von ${name} über ${recipientBusinessName}`,
       html: emailHtml,
     });
-    // ---
-    // --- END OF FIX (Part 2) ---
-    // ---
 
-    if (emailError) { console.error("Error sending email via Resend:", emailError); return NextResponse.json({ error: "Failed to send message email notification." }, { status: 500 }); }
-    console.log("Email sent successfully:", emailData);
+    if (emailError) {
+      console.error('Error sending email via Resend:', emailError);
+      return NextResponse.json({ error: 'Failed to send message email notification.' }, { status: 500 });
+    }
+    console.log('Email sent successfully:', emailData);
 
-    // Success
-    return NextResponse.json({ message: "Nachricht erfolgreich gesendet!" });
+    return NextResponse.json({ message: 'Nachricht erfolgreich gesendet!' });
 
   } catch (error) {
-       // Catch errors from fetching email or other unexpected issues
-      console.error("Unhandled error in contact API:", error);
-      const message = error instanceof Error ? error.message : "An internal server error occurred.";
-      return NextResponse.json({ error: message }, { status: 500 });
+    console.error('Unhandled error in contact API:', error);
+    const messageText = error instanceof Error ? error.message : 'An internal server error occurred.';
+    return NextResponse.json({ error: messageText }, { status: 500 });
   }
 }
diff --git a/src/app/api/request-testimonial/route.ts b/src/app/api/request-testimonial/route.ts
index d9ee060..a9e922f 100644
--- a/src/app/api/request-testimonial/route.ts
+++ b/src/app/api/request-testimonial/route.ts
@@ -5,20 +5,6 @@ import { cookies } from 'next/headers';
 import { createClient } from '@supabase/supabase-js';
 import { Resend } from 'resend';
 
-// Initialize Resend
-const resendApiKey = process.env.RESEND_API_KEY;
-const fromEmail = process.env.FROM_EMAIL;
-if (!resendApiKey || !fromEmail) {
-  console.warn("Missing RESEND_API_KEY or FROM_EMAIL for testimonial requests.");
-}
-const resend = new Resend(resendApiKey);
-
-// Initialize Supabase Admin (we need this to create the request token)
-const supabaseAdmin = createClient(
-  process.env.NEXT_PUBLIC_SUPABASE_URL!,
-  process.env.SUPABASE_SERVICE_ROLE_KEY!
-);
-
 // --- Define Profile type for the joined data ---
 // --- FIX 1: Changed 'profiles' to be an array type to match TS inference ---
 type ProjectWithProfile = {
@@ -33,6 +19,28 @@ export async function POST(request: Request) {
   const supabase = createRouteHandlerClient({ cookies: () => cookieStore });
 
   try {
+    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
+    const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
+    const resendApiKey = process.env.RESEND_API_KEY;
+    const fromEmail = process.env.FROM_EMAIL;
+
+    if (!supabaseUrl || !supabaseServiceRoleKey) {
+      console.error('Missing Supabase service configuration for testimonial request route.');
+      return NextResponse.json({ error: 'Server configuration error (database).' }, { status: 500 });
+    }
+
+    if (!resendApiKey || !fromEmail) {
+      console.error('Missing Resend configuration for testimonial request route.');
+      return NextResponse.json({ error: 'Server configuration error (email).' }, { status: 500 });
+    }
+
+    const supabaseAdmin = createClient(
+      supabaseUrl,
+      supabaseServiceRoleKey,
+    );
+
+    const resend = new Resend(resendApiKey);
+
     // 1. Get and authenticate the user
     const { data: { user } } = await supabase.auth.getUser();
     if (!user) {
@@ -44,7 +52,7 @@ export async function POST(request: Request) {
     if (!projectId || !clientEmail) {
       return NextResponse.json({ error: 'projectId and clientEmail are required' }, { status: 400 });
     }
-    
+
     // We expect projectId to be a number (bigint) but it comes as a string from JSON
     const projectIdNum = parseInt(projectId, 10);
     if (isNaN(projectIdNum)) {
@@ -56,17 +64,17 @@ export async function POST(request: Request) {
       .from('projects')
       .select('title, profiles ( business_name )')
       .eq('id', projectIdNum) // Use the number
-      .eq('user_id', user.id) 
+      .eq('user_id', user.id)
       .single();
 
     if (projectError || !projectData) {
-      console.error("Error fetching project data or no access:", projectError);
+      console.error('Error fetching project data or no access:', projectError);
       return NextResponse.json({ error: 'Project not found or access denied' }, { status: 404 });
     }
-    
+
     // Cast the data to our type to help TypeScript
     const typedProjectData = projectData as ProjectWithProfile;
-    
+
     const projectTitle = typedProjectData.title || 'ein kürzliches Projekt';
     // --- FIX 2: Access the first item in the 'profiles' array ---
     const businessName = typedProjectData.profiles?.[0]?.business_name || 'Ihrem Handwerksbetrieb';
@@ -79,21 +87,32 @@ export async function POST(request: Request) {
         project_id: projectIdNum, // Use the number
         client_email: clientEmail
       })
-      .select('id') 
+      .select('id')
       .single();
-    
+
     if (tokenError || !requestData) {
-      console.error("Error creating testimonial token:", tokenError);
+      console.error('Error creating testimonial token:', tokenError);
       return NextResponse.json({ error: 'Could not create testimonial request token.' }, { status: 500 });
     }
 
     const token = requestData.id;
-    const reviewUrl = `${process.env.NEXT_PUBLIC_SITE_URL}/review/${token}`;
+
+    const resolvedOrigin =
+      process.env.NEXT_PUBLIC_SITE_URL ||
+      request.headers.get('origin') ||
+      new URL(request.url).origin;
+
+    if (!resolvedOrigin) {
+      console.error('Unable to resolve site URL for testimonial email.');
+      return NextResponse.json({ error: 'Server configuration error (site url).' }, { status: 500 });
+    }
+
+    const reviewUrl = `${resolvedOrigin.replace(/\/$/, '')}/review/${token}`;
 
     // 5. Ask OpenAI to draft the email (The "Magic")
     const apiKey = process.env.OPENAI_API_KEY;
     if (!apiKey) {
-      return NextResponse.json({ error: "Server configuration error (AI)" }, { status: 500 });
+      return NextResponse.json({ error: 'Server configuration error (AI)' }, { status: 500 });
     }
 
     const prompt = `Schreibe eine kurze, höfliche E-Mail (auf Deutsch) an einen Kunden, um nach einer Kundenstimme für ein abgeschlossenes Projekt zu fragen.
@@ -102,7 +121,8 @@ export async function POST(request: Request) {
     - E-Mail soll den Kunden direkt ansprechen (z.B. "Sehr geehrter Kunde," oder neutraler).
     - Mache es kurz und freundlich.
     - Erwähne, dass es nur ein paar Minuten dauert.
-    - WICHTIG: Die E-Mail MUSS den folgenden Platzhalter GENAU SO enthalten, damit ich den Link einfügen kann: [REVIEW_LINK_URL]`;
+    - WICHTIG: Die E-Mail MUSS den folgenden Platzhalter GENAU SO enthalten, damit ich den Link einfügen kann: [REVIEW_LINK_URL]
+`;
 
     let emailBody = `
       <p>Sehr geehrter Kunde,</p>
@@ -122,8 +142,8 @@ export async function POST(request: Request) {
           'Authorization': `Bearer ${apiKey}`,
         },
         body: JSON.stringify({
-          model: "gpt-3.5-turbo",
-          messages: [{ role: "user", content: prompt }],
+          model: 'gpt-3.5-turbo',
+          messages: [{ role: 'user', content: prompt }],
           temperature: 0.7,
         }),
       });
@@ -138,12 +158,12 @@ export async function POST(request: Request) {
         }
       }
     } catch (aiError) {
-      console.warn("AI email generation failed, using fallback template.", aiError);
+      console.warn('AI email generation failed, using fallback template.', aiError);
       // Fallback email body is already set
     }
-    
+
     // 6. Send the email via Resend
-    await resend.emails.send({
+    const { data: emailData, error: emailError } = await resend.emails.send({
       from: `${businessName} <${fromEmail}>`,
       to: [clientEmail],
       replyTo: user.email, // Use correct camelCase
@@ -151,11 +171,18 @@ export async function POST(request: Request) {
       html: emailBody,
     });
 
+    if (emailError) {
+      console.error('Error sending testimonial request email via Resend:', emailError);
+      return NextResponse.json({ error: 'Failed to send testimonial request email.' }, { status: 500 });
+    }
+
+    console.info('Testimonial request email queued successfully:', emailData?.id);
+
     return NextResponse.json({ success: true, message: 'Anfrage gesendet!' });
 
   } catch (error) {
-    console.error("Error in /api/request-testimonial:", error);
-    const errorMessage = error instanceof Error ? error.message : "An unknown error occurred";
+    console.error('Error in /api/request-testimonial:', error);
+    const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred';
     return NextResponse.json({ error: errorMessage }, { status: 500 });
   }
 }
diff --git a/src/app/api/review/verify-token/route.ts b/src/app/api/review/verify-token/route.ts
index 74e9ebe..a31fa3f 100644
--- a/src/app/api/review/verify-token/route.ts
+++ b/src/app/api/review/verify-token/route.ts
@@ -2,14 +2,21 @@
 import { NextResponse } from 'next/server';
 import { createClient } from '@supabase/supabase-js';
 
-// We can use the anon key for this read-only, RLS-protected query
-const supabase = createClient(
-  process.env.NEXT_PUBLIC_SUPABASE_URL!,
-  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
-);
-
 export async function POST(request: Request) {
   try {
+    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
+    const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
+
+    if (!supabaseUrl || !supabaseAnonKey) {
+      console.error('Missing Supabase configuration for review token verification.');
+      return NextResponse.json({ error: 'Server configuration error (database).' }, { status: 500 });
+    }
+
+    const supabase = createClient(
+      supabaseUrl,
+      supabaseAnonKey,
+    );
+
     const { token } = await request.json();
 
     if (!token) {
@@ -25,7 +32,7 @@ export async function POST(request: Request) {
       .single();
 
     if (requestError || !requestData) {
-      console.error("Verify token error:", requestError);
+      console.error('Verify token error:', requestError);
       return NextResponse.json({ error: 'Token not found' }, { status: 404 });
     }
 
@@ -41,7 +48,7 @@ export async function POST(request: Request) {
       .single();
 
     if (projectError) {
-      console.error("Project fetch error:", projectError);
+      console.error('Project fetch error:', projectError);
       return NextResponse.json({ error: 'Could not find project details' }, { status: 500 });
     }
 
@@ -51,9 +58,9 @@ export async function POST(request: Request) {
       .select('business_name')
       .eq('id', requestData.profile_id)
       .single();
-    
+
     if (profileError) {
-      console.error("Profile fetch error:", profileError);
+      console.error('Profile fetch error:', profileError);
       return NextResponse.json({ error: 'Could not find business details' }, { status: 500 });
     }
     // --- END NEW STRATEGY ---
@@ -65,9 +72,8 @@ export async function POST(request: Request) {
     });
 
   } catch (error) {
-    console.error("Error in /api/review/verify-token:", error);
-    const errorMessage = error instanceof Error ? error.message : "An unknown error occurred";
+    console.error('Error in /api/review/verify-token:', error);
+    const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred';
     return NextResponse.json({ error: errorMessage }, { status: 500 });
   }
 }
-
diff --git a/src/app/login/page.tsx b/src/app/login/page.tsx
index 7a452c9..836c147 100644
--- a/src/app/login/page.tsx
+++ b/src/app/login/page.tsx
@@ -35,6 +35,17 @@ export default function LoginPage() {
   const [resendLoading, setResendLoading] = useState(false);
   const router = useRouter();
 
+  const resolveSiteUrl = (): string | null => {
+    const envUrl = process.env.NEXT_PUBLIC_SITE_URL;
+    if (envUrl && envUrl.trim().length > 0) {
+      return envUrl;
+    }
+    if (typeof window !== 'undefined' && window.location?.origin) {
+      return window.location.origin;
+    }
+    return null;
+  };
+
   const handleLogin = async (event: React.FormEvent<HTMLFormElement>) => {
     event.preventDefault();
     setLoading(true);
@@ -78,19 +89,19 @@ export default function LoginPage() {
     setMessage(null);
     setShowResendButton(false);
 
-    //
-    // --- THIS IS THE FIX ---
-    //
-    // Get the site URL from the environment variable we just set
-    const redirectUrl = `${process.env.NEXT_PUBLIC_SITE_URL}/reset-password`;
+    const baseUrl = resolveSiteUrl();
+    if (!baseUrl) {
+      setResetLoading(false);
+      toast.error("Unable to determine the site URL for password reset. Please try again later.");
+      return;
+    }
+
+    const redirectUrl = `${baseUrl.replace(/\/$/, '')}/reset-password`;
     console.log("Sending password reset, redirecting to:", redirectUrl);
 
     const resetPromise = supabase.auth.resetPasswordForEmail(email, {
       redirectTo: redirectUrl, // Use the environment variable
     });
-    //
-    // --- END OF FIX ---
-    //
 
     await toast.promise(
       resetPromise,
-- 
2.43.0

